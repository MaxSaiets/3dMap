# Оптимізація підложки та стінок рельєфу

## Проблеми, виявлені на фото

1. **Занадто товста підложка** - база була дуже товстою, створюючи "подиумний" ефект
2. **Багато вертикальних стінок** - створювалося занадто багато вертикальних ліній від граничних вершин
3. **Сітчастий патерн** - можлива проблема з деталізацією mesh

## Виправлення

### 1. Обмеження товщини підложки

**Файл:** `services/terrain_generator.py` → `create_solid_terrain()`

**Проблема:** Base створювався від мінімальної висоти рельєфу мінус товщина, що при великому перепаді висот створювало занадто товсту базу.

**Рішення:**
```python
# Обмежуємо base_thickness до розумного максимуму
min_base_thickness = 0.3  # Мінімум 0.3м (зменшено з 0.5м)
max_base_thickness = 2.0  # Максимум 2.0м - не дозволяємо занадто товстій базі

# Обмежуємо base_thickness відносно висоти рельєфу
# Не дозволяємо base бути більше 10% від висоти рельєфу
if z_range > 0:
    max_base_relative = z_range * 0.1  # Максимум 10% від висоти рельєфу
    effective_base_thickness = min(effective_base_thickness, max_base_relative)

# Адаптація до типу рельєфу
if z_range < 5.0:  # Плоский рельєф
    effective_base_thickness = max(effective_base_thickness * 0.6, min_base_thickness)
elif z_range > 50.0:  # Крутий рельєф
    effective_base_thickness = min(effective_base_thickness, 1.5)  # Максимум 1.5м
```

**Результат:**
- Base не може бути більше 2.0м (або 10% від висоти рельєфу)
- Для плоского рельєфу base ще тонший (60% від заданої товщини)
- Для крутого рельєфу base обмежений до 1.5м

### 2. Оптимізація створення стінок

**Файл:** `services/terrain_generator.py` → `create_solid_terrain()`

**Проблема:** Створювалося занадто багато стінок від кожної пари граничних вершин, що створювало багато вертикальних ліній.

**Рішення:**
```python
# Обмежуємо кількість вершин для стінок
max_wall_vertices = 50  # Максимальна кількість вершин на одну стінку

def simplify_edge_vertices(edge_verts, sort_axis, max_verts=max_wall_vertices):
    """Спрощує граничні вершини, об'єднуючи близькі"""
    if len(edge_verts) == 0:
        return edge_verts
    
    # Сортуємо по заданій осі
    edge_verts = edge_verts[edge_verts[:, sort_axis].argsort()]
    
    # Якщо вершин занадто багато, вибираємо рівномірно розподілені
    if len(edge_verts) > max_verts:
        indices = np.linspace(0, len(edge_verts) - 1, max_verts, dtype=int)
        edge_verts = edge_verts[indices]
    
    return edge_verts
```

**Результат:**
- Максимум 50 вершин на одну стінку (замість сотень)
- Рівномірно розподілені вершини для кращого вигляду
- Менше вертикальних ліній, більш чистий вигляд

### 3. Оптимізація товщини підложки для синхронізованих зон

**Файл:** `services/elevation_sync.py` → `calculate_optimal_base_thickness()`

**Проблема:** Для синхронізованих зон використовувалася товщина 1.0мм, що все ще могло бути занадто багато.

**Рішення:**
```python
if elevation_ref_m is not None:
    # Для синхронізованих зон використовуємо ще меншу товщину
    optimal_thickness = max(min_base_thickness_mm * 0.8, 0.8)  # Мінімум 0.8мм
```

**Результат:**
- Для синхронізованих зон товщина зменшена до 0.8мм (замість 1.0мм)
- Менша підложка = кращий вигляд моделі

## Формула обчислення товщини

### Етап 1: Обчислення оптимальної товщини (мм)
```
if elevation_ref_m is not None:
    optimal_thickness = max(0.8, min_base_thickness_mm * 0.8)
else:
    optimal_thickness = min_base_thickness_mm * 1.2
```

### Етап 2: Конвертація в метри (світові одиниці)
```
base_thickness_m = optimal_thickness_mm / scale_factor
```

### Етап 3: Обмеження в create_solid_terrain
```
min_base_thickness = 0.3м
max_base_thickness = 2.0м
max_base_relative = z_range * 0.1  # 10% від висоти рельєфу

effective_base_thickness = max(base_thickness_m, min_base_thickness)
effective_base_thickness = min(effective_base_thickness, max_base_thickness)
effective_base_thickness = min(effective_base_thickness, max_base_relative)

# Адаптація до типу рельєфу
if z_range < 5.0:  # Плоский
    effective_base_thickness = max(effective_base_thickness * 0.6, min_base_thickness)
elif z_range > 50.0:  # Крутий
    effective_base_thickness = min(effective_base_thickness, 1.5)
```

## Приклади

### Плоский рельєф (перепад < 5м)
```
Задана товщина: 2.0мм
Модель: 100мм
Scale factor: 1000 (1мм на моделі = 1м у світі)

1. optimal_thickness = 0.8мм (синхронізовані зони)
2. base_thickness_m = 0.8мм / 1000 = 0.0008м
3. effective_base_thickness = max(0.0008, 0.3) = 0.3м
4. Для плоского рельєфу: 0.3 * 0.6 = 0.18м
5. Фінальна товщина: 0.18м (1.8мм на моделі)
```

### Крутий рельєф (перепад > 50м)
```
Задана товщина: 2.0мм
Модель: 100мм
Scale factor: 1000
Z range: 80м

1. optimal_thickness = 0.8мм
2. base_thickness_m = 0.0008м
3. effective_base_thickness = max(0.0008, 0.3) = 0.3м
4. max_base_relative = 80 * 0.1 = 8.0м (не обмежує)
5. Для крутого рельєфу: min(0.3, 1.5) = 0.3м
6. Фінальна товщина: 0.3м (3мм на моделі)
```

### Дуже великий перепад (перепад > 100м)
```
Задана товщина: 5.0мм
Модель: 200мм
Scale factor: 2000
Z range: 150м

1. optimal_thickness = 0.8мм
2. base_thickness_m = 0.0008м
3. effective_base_thickness = max(0.0008, 0.3) = 0.3м
4. max_base_relative = 150 * 0.1 = 15.0м (не обмежує)
5. max_base_thickness = 2.0м (не обмежує)
6. Для крутого рельєфу: min(0.3, 1.5) = 0.3м
7. Фінальна товщина: 0.3м (3мм на моделі)
```

## Переваги виправлень

1. **Тонша підложка** - base не може бути занадто товстою
2. **Менше стінок** - максимум 50 вершин на стінку замість сотень
3. **Кращий вигляд** - менше вертикальних ліній, більш чистий mesh
4. **Адаптивність** - товщина адаптується до типу рельєфу
5. **Синхронізація** - для синхронізованих зон використовується мінімальна товщина

## Діагностика

### Перевірка правильності роботи

**Логи:**
```
[DEBUG] Terrain height range: 25.34м, base_thickness: 0.30м (requested: 0.50м, min: 150.23м, max: 175.57м)
```

**Якщо бачите:**
- `base_thickness: X.XXм` - фінальна товщина після обмежень
- `requested: X.XXм` - задана товщина (до обмежень)
- Товщина не повинна перевищувати 2.0м або 10% від висоти рельєфу

### Перевірка стінок

**Кількість вершин на стінку:**
- Максимум 50 вершин на одну стінку
- Рівномірно розподілені вершини
- Менше вертикальних ліній

## Відомі обмеження

1. **Мінімальна товщина** - 0.3м в світових одиницях (для стабільності)
2. **Максимальна товщина** - 2.0м або 10% від висоти рельєфу
3. **Стіни** - завжди створюються для watertight mesh (не можна відключити)

## Майбутні покращення

1. **Опція відключення стінок** - для моделей, де стіни не потрібні
2. **Адаптивна кількість вершин** - більше вершин для великих моделей
3. **Плавні стіни** - використання кривих замість прямих ліній
4. **Візуалізація base** - показувати товщину base на прев'ю

