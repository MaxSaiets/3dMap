# Покращення текстури зелених зон: Low Poly ефект

## Проблема

При друку білих моделей (без кольорів) важко розрізнити різні зони:
- Всі поверхні виглядають однаково білими
- Немає контрасту між асфальтом, травою та будівлями
- Втрачається розуміння структури моделі

## Рішення: Low Poly (кристалічна) текстура

Замість кольорів використовуємо **гру світла і тіні** через геометричну текстуру:
- Створюємо "ламану" поверхню з великими гранями
- Грані відкидають чіткі тіні навіть на білому пластику
- Тактильна різниця: "гладке" (дороги/будівлі) vs "шорстке" (природа)

---

## Основні зміни

### 1. Збільшена амплітуда текстури

**Було:** `target_noise_mm = 0.25 мм`
**Стало:** `target_noise_mm = 0.5 мм`

**Чому:**
- 0.5мм на моделі створює добре видимі тіні
- Достатньо високо, щоб відкидати тіні, але не спотворює геометрію
- Можна збільшити до 0.7-1.0мм для дуже стилізованого вигляду

### 2. Контрольована густота сітки

**Було:** Subdivision для мешів < 10000 вершин (1 ітерація)
**Стало:** Subdivision тільки для простих мешів (< 500 вершин, до 2 ітерацій)

**Чому:**
- Великі трикутники створюють виразні грані (Low Poly ефект)
- Дрібна сітка виглядає як "пісок" (шум), а не структура
- Обмежуємо кількість вершин для продуктивності

### 3. Прибрано хвильову компоненту

**Було:** Додавався хвильовий паттерн (sin/cos) для "природності"
**Стало:** Тільки випадковий шум (гострі піки)

**Чому:**
- Хвилі створюють згладжену поверхню (smooth shading)
- Нам потрібні гострі грані для чітких тіней (flat shading)
- Випадковий шум створює хаотично-геометричну структуру (як на фото)

### 4. Flat Shading

**Додано:** `mesh.fix_normals()` після застосування шуму

**Чому:**
- Перераховує нормалі граней для правильного Flat Shading
- Забезпечує чіткі грані замість згладжених поверхонь
- Тіні стають більш виразними

---

## Технічні деталі

### Алгоритм створення текстури

1. **Підготовка сітки:**
   ```python
   if len(mesh.vertices) < 500:
       mesh = mesh.subdivide()  # Базова геометрія
       if len(mesh.vertices) < 1000:
           mesh = mesh.subdivide()  # Додаткова деталізація для великих парків
   ```

2. **Визначення верхньої поверхні:**
   ```python
   # Використовуємо нормалі вершин (надійніше на крутих схилах)
   up_facing = mesh.vertex_normals[:, 2] > 0.5
   ```

3. **Розрахунок амплітуди:**
   ```python
   target_noise_mm = 0.5  # мм на моделі
   texture_amplitude = target_noise_mm / scale_factor  # метри світу
   texture_amplitude = min(texture_amplitude, 3.0)  # Максимум 3 метри
   ```

4. **Генерація шуму:**
   ```python
   noise = (random - 0.5) * 2.0 * texture_amplitude
   mesh.vertices[top_indices, 2] += noise
   ```

5. **Flat Shading:**
   ```python
   mesh.fix_normals()  # Перераховує нормалі для чітких граней
   ```

---

## Налаштування параметрів

### Якщо текстура занадто дрібна (як пісок):

**Проблема:** Трикутники занадто малі, текстура виглядає як шум

**Рішення:**
- Зменшити кількість subdivision:
  ```python
  if len(mesh.vertices) < 300:  # Замість 500
      mesh = mesh.subdivide()
  ```
- Або прибрати другий `subdivide()` повністю

### Якщо текстура занадто плоска (не видно тіней):

**Проблема:** Амплітуда занадто мала, тіні не видно

**Рішення:**
- Збільшити `target_noise_mm`:
  ```python
  target_noise_mm = 0.7  # Замість 0.5
  # Або навіть
  target_noise_mm = 1.0  # Для дуже стилізованого вигляду
  ```

### Якщо текстура занадто хаотична:

**Проблема:** Це нормально для Low Poly! Головне, щоб вона відрізнялася від гладких поверхонь

**Якщо потрібно більш структуровану текстуру:**
- Можна додати легкий хвильовий паттерн (опціонально):
  ```python
  wave_pattern = np.sin(x_coords / 20.0) * np.cos(y_coords / 20.0) * (texture_amplitude * 0.2)
  mesh.vertices[top_indices, 2] += wave_pattern
  ```

---

## Результати

### До покращення:
- ❌ Текстура занадто дрібна (0.25мм)
- ❌ Хвильовий паттерн згладжує грані
- ❌ Важко розрізнити зони на білій моделі

### Після покращення:
- ✅ Виразна Low Poly текстура (0.5мм)
- ✅ Чіткі грані з Flat Shading
- ✅ Гру тіней для розрізнення зон навіть без кольорів
- ✅ Тактильна різниця між зонами

---

## Приклади використання

### Стандартні налаштування (рекомендовано):
```python
target_noise_mm = 0.5  # Добре видимі тіні
subdivide_threshold = 500  # Середня деталізація
```

### Тонка текстура (для дрібних моделей):
```python
target_noise_mm = 0.3  # Менш видима, але не спотворює геометрію
subdivide_threshold = 300  # Менше деталізації
```

### Виразна текстура (для великих моделей):
```python
target_noise_mm = 0.7  # Дуже видимі тіні
subdivide_threshold = 1000  # Більше деталізації
```

---

## Технічні примітки

### Flat Shading vs Smooth Shading

**Flat Shading (наш вибір):**
- Кожна грань має свою нормаль
- Чіткі межі між гранями
- Створює виразні тіні

**Smooth Shading:**
- Нормалі інтерполюються між гранями
- Згладжена поверхня
- Менш виразні тіні

### Масштабування

Амплітуда автоматично масштабується залежно від `scale_factor`:
- Велика модель (1:500) → більша амплітуда в метрах світу
- Мала модель (1:5000) → менша амплітуда в метрах світу
- На моделі завжди 0.5мм (або налаштоване значення)

### Продуктивність

- Subdivision обмежений для великих мешів
- Шум генерується тільки для верхніх вершин
- Немає складних обчислень (sin/cos прибрано)

---

*Документ створено після покращення текстури для досягнення Low Poly ефекту*

