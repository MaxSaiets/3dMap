# Режим попереднього завантаження даних (Preload Mode)

## Опис

Новий режим роботи системи, де всі OSM дані для України завантажуються **один раз при старті сервера** та зберігаються в пам'яті з просторовим індексом. При кожному запиті дані вибираються з вже завантажених за допомогою spatial index - **швидко та без зайвого навантаження на пам'ять**.

## Переваги

1. **Швидкість**: Запити обробляються миттєво (не потрібно сканувати PBF файл)
2. **Ефективність**: Просторовий індекс дозволяє швидко знаходити потрібні об'єкти за bbox
3. **Стабільність**: Немає повторного завантаження та сканування PBF
4. **Менше навантаження на диск**: PBF файл читається тільки один раз при старті

## Як увімкнути

Режим увімкнено за замовчуванням. Для вимкнення встановіть:

```bash
$env:OSM_PRELOAD='0'
```

Або в `.env` файлі:
```
OSM_PRELOAD=0
```

## Перший запуск

При першому запуску з preload режимом:
1. Сервер завантажить всі дані з PBF файлу (може зайняти 1-3 хвилини)
2. Дані будуть спроєктовані в UTM
3. Створиться spatial index для швидкого пошуку
4. Після цього всі запити будуть оброблятися миттєво

## Використання пам'яті

Preload режим завантажує всі дані України в пам'ять:
- Будівлі: ~100-500 MB (залежить від кількості)
- Вода: ~50-200 MB
- Дороги: ~100-300 MB
- Зелені зони: ~50-150 MB
- POI: ~10-50 MB

**Загалом: ~300-1200 MB** (залежить від розміру даних у PBF)

## Робота системи

1. **При старті сервера** (`@app.on_event("startup")`):
   - Завантажує всі дані з PBF файлу
   - Проєктує їх в UTM координати
   - Створює spatial index для кожного типу даних

2. **При запиті на генерацію**:
   - `fetch_city_data()` перевіряє чи є preloaded дані
   - Якщо так - використовує `get_data_for_bbox()` з spatial index
   - Якщо ні - використовує звичайний режим (PBF/Overpass)

3. **Spatial index**:
   - Використовує `.sindex.intersection()` для швидкого вибору потенційних об'єктів
   - Потім фільтрує через `.intersects()` для точного відбору

## Конфігурація

### Змінні середовища:

- `OSM_PRELOAD` - увімкнути/вимкнути preload режим (за замовчуванням: `1`)
- `OSM_PBF_PATH` - шлях до PBF файлу (за замовчуванням: `cache/osm/ukraine-latest.osm.pbf`)
- `OSM_ROADS_NETWORK_TYPE` - тип дорожньої мережі (`drive`, `walk`, `bike`, за замовчуванням: `drive`)
- `OSM_FETCH_BUILDING_PARTS` - завантажувати building:part (`0` або `1`, за замовчуванням: `0`)

## Альтернативний режим (без preload)

Якщо не вистачає пам'яті або не потрібна висока швидкість:
- Встановіть `OSM_PRELOAD=0`
- Система працюватиме в звичайному режимі з завантаженням по запиту
- Використовується disk cache (Parquet) для прискорення повторних запитів

## Технічні деталі

- Модуль: `services/preloaded_data.py`
- Функції:
  - `load_all_data()` - завантажує всі дані при старті
  - `get_data_for_bbox()` - отримує дані для bbox з preloaded
  - `get_extras_for_bbox()` - отримує extras (green, pois) для bbox
  - `is_loaded()` - перевіряє чи завантажені дані
- Spatial index: використовує вбудований `.sindex` з geopandas (rtree)


