# План рефакторингу обробки доріг для багаторівневих розв'язок

## Проблеми, які потрібно вирішити

1. **Розриви на стиках**: Дороги та мости не з'єднуються через різні формули висоти
2. **Мости лежать на дорогах**: Висота layer * 3.0 замала для багаторівневих розв'язок
3. **Дороги копіюють рельєф**: Мости повинні бути плоскими, а не слідувати за рельєфом

## Ключові зміни

### 1. detect_bridges
- Повертає `(bridge_line, bridge_area, bridge_height, is_over_water)` - 4 елементи
- Layer multiplier: 6.0 (layer=1 -> 6м, layer=2 -> 12м)
- Layer threshold: >= 1.0 (а не >= 2.0)

### 2. process_roads (_process_one)
- **GLOBAL_BIAS = 0.05** для синхронізації всіх доріг
- **Абсолютна висота моста**: `deck_z_level = np.max(ground) + offset` (плоский міст)
- **Опори тільки якщо**: `avg_height > 4.0`

### 3. Мінімальна площа
- `min_piece_area = 0.001` (а не 1.0)

### 4. Clip box
- Розширення на 100м (вже виправлено)

## Алгоритм для мостів

1. Знайти максимальну висоту землі під мостом
2. Додати висоту шару (layer * 6.0)
3. Зробити міст плоским на цій висоті
4. Початок/кінець моста "притягнути" до рівня `GLOBAL_BIAS`

---

**Примітка**: Повний перепис функцій може зламати інші частини коду. Краще впроваджувати поступово, зберігаючи існуючу структуру.

